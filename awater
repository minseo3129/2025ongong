import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeClassifier
from sklearn.impute import SimpleImputer

# âœ… í•œê¸€ í°íŠ¸ ì„¤ì •
matplotlib.rcParams['font.family'] = 'DejaVu Sans'
matplotlib.rcParams['axes.unicode_minus'] = False

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ë¬¼ì˜ ìŒìš© ê°€ëŠ¥ì„± ì˜ˆì¸¡ê¸°", layout="wide")
st.title("ğŸ’§ ìˆ˜ì§ˆ í•­ëª© ê¸°ë°˜ ìŒìš© ê°€ëŠ¥ì„± ì˜ˆì¸¡ê¸°")

# -------------------------------
# 1. ìˆ˜ì§ˆ í•­ëª© ì •ë³´ ì„¤ì •
# -------------------------------
parameter_info = {
    "ph": {
        "label": "pH (ì‚°ì„±/ì•Œì¹¼ë¦¬ì„± ì§€í‘œ)",
        "unit": "",
        "description": "ë¬¼ì˜ ì‚°ë„ ë˜ëŠ” ì—¼ê¸°ì„±ì„ ë‚˜íƒ€ëƒ„. WHO ê¶Œì¥: 6.5â€“8.5"
    },
    "Hardness": {
        "label": "ê²½ë„ (mg/L)",
        "unit": "mg/L",
        "description": "ì¹¼ìŠ˜/ë§ˆê·¸ë„¤ìŠ˜ ì—¼ ë†ë„. ë¬¼ì— ë¯¸ë„¤ë„ì´ ë§ì„ìˆ˜ë¡ ë†’ì•„ì§"
    },
    "Solids": {
        "label": "ì´ ìš©ì¡´ ê³ í˜•ë¬¼ (TDS, mg/L)",
        "unit": "mg/L",
        "description": "ë¬¼ì— ë…¹ì•„ ìˆëŠ” ë¬´ê¸°ë¬¼+ìœ ê¸°ë¬¼. WHO ê¶Œì¥ ìƒí•œ: 1000 mg/L"
    },
    "Chloramines": {
        "label": "í´ë¡œë¼ë¯¼ (mg/L)",
        "unit": "mg/L",
        "description": "ì†Œë… í™”í•©ë¬¼. 4 mg/L ì´ë‚´ê°€ ì•ˆì „"
    },
    "Sulfate": {
        "label": "í™©ì‚°ì—¼ (mg/L)",
        "unit": "mg/L",
        "description": "ì§€ì§ˆ ê¸°ì› ì—¼ë¥˜. ê³ ë†ë„ëŠ” ì¥ë‚´ ë¶ˆí¸ ìœ ë°œ ê°€ëŠ¥"
    },
    "Conductivity": {
        "label": "ì „ê¸°ì „ë„ë„ (Î¼S/cm)",
        "unit": "Î¼S/cm",
        "description": "ì´ì˜¨ ë†ë„. WHO ê¶Œì¥: 400 Î¼S/cm ì´í•˜"
    },
    "Organic_carbon": {
        "label": "ìœ ê¸° íƒ„ì†Œ (mg/L)",
        "unit": "mg/L",
        "description": "ìœ ê¸°ë¬¼ ì´ëŸ‰. EPA ê¸°ì¤€: 2 mg/L ì´í•˜ ê¶Œì¥"
    },
    "Trihalomethanes": {
        "label": "íŠ¸ë¦¬í• ë¡œë©”íƒ„ (Î¼g/L)",
        "unit": "Î¼g/L",
        "description": "ì—¼ì†Œ ì†Œë… ë¶€ì‚°ë¬¼. WHO ì•ˆì „ ê¸°ì¤€: 80 Î¼g/L ì´í•˜"
    },
    "Turbidity": {
        "label": "íƒë„ (NTU)",
        "unit": "NTU",
        "description": "ë¶€ìœ  ë¬¼ì§ˆì˜ í˜¼íƒë„. WHO ê¶Œì¥: 5 NTU ì´í•˜"
    }
}

# -------------------------------
# 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ëª¨ë¸ í•™ìŠµ
# -------------------------------
df = pd.read_csv("water_potability.csv")
imputer = SimpleImputer(strategy="mean")
X = df.drop("Potability", axis=1)
y = df["Potability"]
X_imputed = imputer.fit_transform(X)

X_train, X_test, y_train, y_test = train_test_split(X_imputed, y, test_size=0.2, random_state=42)
model = DecisionTreeClassifier(max_depth=4, random_state=42)
model.fit(X_train, y_train)

# -------------------------------
# 3. ìˆ˜ì¹˜ ì…ë ¥ UI + ì„¤ëª… í‘œì‹œ
# -------------------------------
st.subheader("ğŸ§ª ìˆ˜ì§ˆ í•­ëª© ìˆ˜ì¹˜ ì…ë ¥")

user_input = {}
for col in df.columns[:-1]:
    info = parameter_info[col]
    with st.expander(f"â¤ {info['label']}"):
        value = st.number_input(f"{info['label']} ì…ë ¥ê°’", min_value=0.0, step=0.1, key=col)
        st.caption(f"ë‹¨ìœ„: **{info['unit']}**")
        st.markdown(f"ğŸ’¡ {info['description']}")
        user_input[col] = value

# -------------------------------
# 4. ì˜ˆì¸¡ ê²°ê³¼ ì¶œë ¥
# -------------------------------
if st.button("ì˜ˆì¸¡í•˜ê¸°"):
    input_df = pd.DataFrame([user_input])
    input_df_imputed = pd.DataFrame(imputer.transform(input_df), columns=input_df.columns)
    prediction = model.predict(input_df_imputed)[0]
    prob = model.predict_proba(input_df_imputed)[0][prediction]

    st.markdown("### â“ ì´ ë¬¼ì€ ìŒìš©í•´ë„ ë ê¹Œìš”?")
    if prediction == 1:
        st.success(f"ğŸŸ¢ **ì˜ˆ**, ì´ ë¬¼ì€ ìŒìš© ê°€ëŠ¥í•©ë‹ˆë‹¤! (ì‹ ë¢°ë„: {prob*100:.2f}%)")
    else:
        st.error(f"ğŸ”´ **ì•„ë‹ˆìš”**, ì´ ë¬¼ì€ ìŒìš©ì— ì í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì‹ ë¢°ë„: {prob*100:.2f}%)")

# -------------------------------
# 5. ë³€ìˆ˜ ì¤‘ìš”ë„ ì‹œê°í™”
# -------------------------------
st.subheader("ğŸ“Š ìˆ˜ì§ˆ í•­ëª© ì¤‘ìš”ë„ ì‹œê°í™”")

importances = model.feature_importances_
features_kr = [parameter_info[col]["label"] for col in df.columns[:-1]]

fig, ax = plt.subplots(figsize=(10, 6))
ax.barh(features_kr, importances, color='teal')
ax.set_title("ìŒìš© ê°€ëŠ¥ì„±ì— ì˜í–¥ì„ ì£¼ëŠ” ì£¼ìš” ìˆ˜ì§ˆ í•­ëª©")
ax.invert_yaxis()
st.pyplot(fig)

# -------------------------------
# 6. ê²°ë¡  ì„¤ëª…
# -------------------------------
st.markdown("""
---
ğŸ“˜ **ì„¤ëª… ìš”ì•½**
- ìœ„ ê·¸ë˜í”„ëŠ” ì˜ˆì¸¡ ëª¨ë¸ì´ ê° í•­ëª©ì„ ì–¼ë§ˆë‚˜ ì°¸ê³ í–ˆëŠ”ì§€ ë³´ì—¬ì¤ë‹ˆë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´, `ìœ ê¸° íƒ„ì†Œ`, `íƒë„`, `ì´ ìš©ì¡´ ê³ í˜•ë¬¼` ë“±ì´ ë†’ê²Œ ë‚˜ì˜¤ë©´ ìŒìš© ë¶ˆê°€ í™•ë¥ ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.
- í–¥í›„ `ê²Œì´ì§€ ì‹œê°í™”`, `ì˜¤ì—¼ ì ìˆ˜ ì‹œë®¬ë ˆì´ì…˜` ë“±ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
""")